name: ci-testpypi
on:
  workflow_run:
    workflows: ["ci-unittest"]
    types:
      - completed
  push:
    paths:
      - '.github/workflows/ci-testpypi.yml'
      - 'MANIFEST.in'
      - 'pyproject.toml'
env:
  TIMESTAMP: ${{ format('{0:yyyyMMddHHmm}', github.event.workflow_run.updated_at) }}
  TWINE_USERNAME: __token__
  TWINE_PASSWORD: ${{ secrets.TESTPYPI_TOKEN }}
jobs:
  check-previous-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Check if triggered by schedule
        id: check-trigger
        run: |
          trigger_event=$(gh api repos/:owner/:repo/actions/runs/${{ github.event.workflow_run.id }} --jq '.event')
          if [[ "$trigger_event" == "schedule" ]]; then
            echo "Previous workflow was triggered by schedule, skipping."
            echo "::set-output name=skip::true"
          else
            echo "::set-output name=skip::false"
          fi
      - name: Check run conclusion
        if: steps.check-trigger.outputs.skip == 'false'
        run: |
          conclusion=$(gh api repos/:owner/:repo/actions/runs/${{ github.event.workflow_run.id }} --jq '.conclusion')
          if [[ "$conclusion" != "success" ]]; then
            echo "Previous workflow was not successful, skipping."
            exit 1
          fi

  get-new-version:
    runs-on: ubuntu-latest
    needs: check-previous-workflow
    outputs:
      new_version: ${{ steps.new-version.outputs.new_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Get new version
        id: new-version
        run: |
          python -c "
          import configparser
          config = configparser.ConfigParser()
          config.read('setup.cfg')
          version = config.get('metadata', 'version')
          major, minor, patch = version.split('.')
          suffix = 'dev-' + '${{ env.TIMESTAMP }}'
          new_version = '{0}.{1}.{2}.{3}'.format(major, minor, patch, suffix)
          print('::set-output name=new_version::' + new_version)
          "

  testpypi-py3-build-and-upload:
    runs-on: ubuntu-latest
    needs: get-new-version
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.12.3']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install build twine
      - name: Set new version
        run: |
          python -c "
          import configparser
          config = configparser.ConfigParser()
          new_version = '${{ needs.get-new-version.outputs.new_version }}'
          config.set('metadata', 'version', new_version)
          with open('setup.cfg', 'w') as f:
              config.write(f)
          "
      - name: Build source and binary distributions
        run: python -m build
      - name: Upload to TestPyPI
        run: twine upload --repository testpypi dist/*

  testpypi-py2-build-and-upload:
    runs-on: ubuntu-latest
    needs: [get-new-version, testpypi-py3-build-and-upload]
    container:
      image: python:2.7
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install build twine
      - name: Set new version
        run: |
          python -c "
          import configparser
          config = configparser.ConfigParser()
          new_version = '${{ needs.get-new-version.outputs.new_version }}'
          config.set('metadata', 'version', new_version)
          with open('setup.cfg', 'w') as f:
              config.write(f)
          "
      - name: Build binary distribution only
        run: python -m build -w
      - name: Upload to TestPyPI
        run: twine upload --repository testpypi dist/*

  testpypi-py3-install:
    runs-on: ubuntu-latest
    needs: [get-new-version, testpypi-py3-build-and-upload]
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.12.3']
    env:
      NEW_VERSION: ${{ needs.get-new-version.outputs.new_version }}
    steps:
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: pip install --upgrade pip
      - name: Install from binary distribution
        env:
          PIP_INDEX_URL: https://test.pypi.org/simple/
        run: |
          pip install --no-deps --only-binary shadowsocks-manager shadowsocks-manager==${{ env.NEW_VERSION }}
      - name: Clean up for source distribution
        run: |
          pip uninstall -y shadowsocks-manager
      - name: Install from source distribution with PEP 517 required
        env:
          PIP_INDEX_URL: https://test.pypi.org/simple/
        run: |
          pip install --use-pep517 --no-deps --no-binary shadowsocks-manager shadowsocks-manager==${{ env.NEW_VERSION }}

  testpypi-py2-install:
    runs-on: ubuntu-latest
    needs: [get-new-version, testpypi-py2-build-and-upload]
    container:
      image: python:2.7
    env:
      NEW_VERSION: ${{ needs.get-new-version.outputs.new_version }}
    steps:
      - name: Install dependencies
        run: pip install --upgrade pip setuptools
      - name: Install from binary distribution
        env:
          PIP_INDEX_URL: https://test.pypi.org/simple/
        run: |
          pip install --no-deps --only-binary shadowsocks-manager shadowsocks-manager==${{ env.NEW_VERSION }}
      - name: Clean up for source distribution
        run: |
          pip uninstall -y shadowsocks-manager
      - name: Install from source distribution with setuptools required
        env:
          PIP_INDEX_URL: https://test.pypi.org/simple/
        run: |
          pip install --no-deps --no-binary shadowsocks-manager shadowsocks-manager==${{ env.NEW_VERSION }}
